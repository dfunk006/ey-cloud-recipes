# Built with Chef recipe nginx_conf

upstream upstream_bfwa {
    server unix:/var/run/engineyard/php-fpm_bfwa.sock;
}

# Include additional server blocks.  File copied in via deploy hooks
include /etc/nginx/servers/bfwa/additional_server_blocks.customer;

server {
    listen      80;
    server_name _;

    port_in_redirect off;

    root  /data/bfwa/current//;
    index index.php index.html index.htm;

    access_log /var/log/engineyard/nginx/bfwa.access.log main;
    error_log  /var/log/engineyard/nginx/bfwa.error.log  notice;

    client_max_body_size 100M;
    error_page 404 /404.html;
    error_page 500 502 504 /500.html;

    if (-f /data/bfwa/current/public/system/maintenance.html) {
        return 503;
    }

    location = /favicon.ico {
        access_log     off;
        log_not_found  off;
    }

	# Include additional location blocks.  File copied in via deploy hooks
	include /etc/nginx/servers/bfwa/additional_location_blocks.customer;

    location / {
        try_files $uri $uri/ /index.php?it=$uri&$args;
    }

    location ~ \.php$ {
        try_files $uri =404;

        include                     /etc/nginx/common/proxy.conf;
        include                     /etc/nginx/common/fcgi.conf;
        fastcgi_pass                upstream_bfwa;
        fastcgi_index               index.php;
        fastcgi_intercept_errors    off;
        fastcgi_param               SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param               SERVER_NAME $hostname;
    }

    location ~* ^.+\.(jpg|js|jpeg|png|ico|gif|txt|js|css|swf|zip|rar|avi|exe|mpg|mp3|wav|mpeg|asf|wmv)$ {
        try_files $uri /index.php$is_args$args;
        expires 24h;
    }

    location = /500.html {
        root /data/bfwa/current;
    }

    error_page 503 @maint;
    location @maint {
        root /data/bfwa/current/public/system;
        if (!-f $request_filename) {
            rewrite ^(.*)$ /maintenance.html break;
        }
        return 200;
    }

    include /etc/nginx/servers/bfwa/custom.conf;
}
